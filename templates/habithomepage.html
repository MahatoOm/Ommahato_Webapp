<!DOCTYPE html>
<html lang = "en">
    <head>
        <meta charset="UTF-8">
        <title>
            Habit Tracker
        </title>
        <style>
            .container {
                padding: 16px 24px;
                /* width: 100vw; */
                overflow-x: hidden;    /* horizontal scroll
                /* white-space: nowrap; */
            }
            .logoside{
                display : flex;
                flex-direction: column;
                /* space-betwen: 12 px; */
                align-items: center;
                margin-bottom: 0 px;
                
            }
            /* logo text */
            #logo{
                font-size:34px;
                font-weight:800;
                letter-spacing: 1px;
                color : #0ea5e9;
                margin:0;
                padding:8px 24px;
                border-radius:14px;
                /* background: linear-gradient(135deg, #e0f7ff, #f0fcff); */
                box-shadow: 0 10px 24px rgba(14,165,233,0.25);
                position: relative;

            }

            /* Small accent underline */
            /* #logo::after {
                content: "";
                position: absolute;
                bottom:-6px;
                left:50%;
                transform:translatex(-50%);
                width: 60%;
                height: 4px;
                background: linear-gradient(to right, #38d1f0, #0ea5e9);
                border-radius: 4px;
            } */

            /* ===== TOP HEADER BAR ===== */
            .head-controls {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 5px 20px;
                background: linear-gradient(135deg, #FDEDED, #e7cdbc);
                color: #161E54;
                border-radius: 0 0 14px 14px;
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
                margin-bottom: 18px;
            }

            .head-controls h1 {
                margin: 0;
                font-size: 26px;
                font-weight: 700;
            }

            /* Right-side user/admin section */
            #head-admin {
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 14px;
            }

            /* Login / Logout buttons */
            #head-admin button {
                padding: 6px 14px;
                border-radius: 8px;
                border: none;
                cursor: pointer;
                font-weight: 600;
                background: white;
                color: #1aa7c6;
                transition: all 0.2s ease;
            }

            #head-admin button:hover {
                background: #e0f7fc;
            }

            /* ===== SAVE BUTTON ===== */
            button[onclick="saveChanges()"] {
                background: #22c55e;
                color: white;
                border: none;
                padding: 10px 22px;
                border-radius: 10px;
                font-size: 15px;
                font-weight: 700;
                cursor: pointer;
                box-shadow: 0 6px 18px rgba(34, 197, 94, 0.35);
                transition: transform 0.15s ease, box-shadow 0.15s ease;
            }

            button[onclick="saveChanges()"]:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 22px rgba(34, 197, 94, 0.45);
            }
            /* ===== NAV CONTROLS ===== */
            .nav-controls {
                display: flex;
                justify-content: center;
                gap: 12px;
                margin-bottom: 16px;
            }

            .nav-controls button {
                padding: 8px 16px;
                border-radius: 10px;
                border: none;
                background: #FF986A;
                color: white;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s ease, transform 0.15s ease;
            }

            .nav-controls button:hover {
                background: #1aa7c6;
                transform: translateY(-1px);
            }

            /* ==== TABLE CONTROLS ===== */

            table {
                width: 100%;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            }

            th, td {
                border: 1px solid #444;
                position:relative;
            }
            th {
                background : #f2f2f2;
            }
            td {
                background: white;
                padding: 6px;
                transition: background 0.15s ease;
            }

            td:hover {
                background: #f0f9ff;
            }

            tr:first-child td,
            tr:first-child th {
                border-top: 2px solid #38d1f0;
            }

            select, textarea {
                width:90%;
                margin-top:4px;
            }
            textarea {
                height : 45px;
            }
            thead th {
                background: linear-gradient(to bottom, #e6f9fd, #d1f3fb);
                color: #0369a1;
                font-weight: 700;
                padding: 12px;
                position: sticky;
                top: 0;
                z-index: 30;
            }
            tbody th {
                background: #f8fafc;
                font-weight: 700;
                color: #0f172a;
                position: sticky;
                left: 0;
                z-index: 20;
                min-width: 160px;
            }


            

            /* Floating action menu */
            .cell-menu {
            display: none;
            position: absolute;
            top: 4px;
            right: 4px;
            background: #fff;
            border: 1px solid #aaa;
            z-index: 10;
            }
            .cell-menu button {
            display: block;
            width: 100%;
            border: none;
            background: none;
            padding: 4px 8px;
            cursor: pointer;
            }
            .cell-menu button:hover {
            background: #eee;
            }

            .nav-controls{
                display : flex;
                justify-content:space-between;
                margin-bottom: 10px;
            }

            .head-controls{
                display : flex;
                justify-content:space-between;
                margin-bottom: 10px;
                margin-left: 20px;
                margin-right:20px;
            }
            .login{
                margin:100px;
            }
            head-admin{
                display: grid;
            }
            /* The class we will add to column i == 3 */
            .highlight-column {
                background-color: #f0f7ff !important; /* Light blue tint */
                border-left: 2px solid #3b82f6 !important;
                border-right: 2px solid #3b82f6 !important;
                position: relative;
                z-index: 10;
                /* This creates the blue shadow "lift" effect */
                box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2), 
                            0 4px 6px -2px rgba(59, 130, 246, 0.1);
            }

            /* Add top border to header cell only */
            th.highlight-column {
                border-top: 2px solid #3b82f6 !important;
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
                color: #f59e0b
            }

            /* Add bottom border to last row cell only */
            tr:last-child td.highlight-column {
                border-bottom: 2px solid #3b82f6 !important;
                border-bottom-left-radius: 8px;
                border-bottom-right-radius: 8px;
            }
            /* Style for the currently selected cell */
            .selected-cell {
                background-color: #fffbeb !important; /* Light amber/yellow background */
                outline: 3px solid #f59e0b !important; /* Amber border */
                outline-offset: -3px; /* Keeps the outline inside the cell */
                z-index: 20;
                position: relative;
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>

    </head>
    <body >
        <div class = "head-controls">  
        <div class = "logoside">
            <div>

                <h1 id = "logo">
                    Habit Tracker
                </h1>
            </div>
        <div class="nav-controls">
            <!-- <div>
                <button onclick="changeWeek(-1)"> üëà Previouos Week</button>
                <button onclick="changeWeek(1)"> üëâ Next Week</button>
            </div> -->

            <div>
                
                <!-- <button onclick="addDay()">üóΩ New Day</button> -->
                <button onclick="previousWeek()">üóΩ Previous Week</button>
                <button onclick="addWeek()">üóìÔ∏è New Week</button>
            </div>
        </div> 
        </div>
        <button onclick = saveChanges() > Save All</button>
        <div id = head-admin>
            <form action = '/logincheck'>
           <h3>Hi, {{ username }} </h3>
            <h5>{{ email }}</h5>
            {% if username == "Friend"  or username == None %}
            <button id='actionlogin' name='actionlogin'>Login</button>
            <p>Status: <span id="statusMessage">Waiting...</span></p>
            {% elif (email) %}
            <button id='actionlogout' name='actionlogout'>Log Out</button>
            {% endif %}    
            </form>    
        </div>  
            
        
        
        </div>

        <div class = "container">
            

        <form >
            <table id = "trackerTable" ">
                <thead id = "headerRow">
                    <tr id = "dateRow">
                        <th>Activity</th>
                    </tr>
                </thead>
                <tbody id = "bodyRows">
                    {% for activity in activities %}
                    <tr>
                        
                        <th>{{ activity }}</th>
                        
                    </tr>
                    {% endfor %}
                    
                </tbody>
            </table>

            <br>
            <button onclick = saveChanges() > Save All</button>
        </form>
        </div>
        <script>
            // converting python list to javascript readable format, Json is that bridge

            activities = JSON.parse('{{ activities | tojson | safe }}');
            totalweekdata = {{ totalweekdata | tojson }};
            console.log("Activities:", activities);

            const table = document.getElementById("trackerTable");
            const headerRow = document.getElementById("dateRow");
            const bodyRows = table.querySelectorAll("tbody tr");
            // const bodyRows = Array.from(document.getElementById("bodyRows").children);


            // tracks current time Sun Dec 14 2025 6:38:32 GMT-0600 
            let startDate = new Date();
            let todayDate = new Date();
            startDate.setDate(startDate.getDate() - 3);
            let endDate = new Date();
            endDate.setDate(startDate.getDate() +7);
            let day = 7;


            const changedData = {};
            function markChanged(activity, dayIndex, field, value, chdate) {
                change_date = chdate.getFullYear() + "-" +
                        String(chdate.getMonth() + 1).padStart(2, "0") + "-" +
                        String(chdate.getDate()).padStart(2, "0");
                if (!changedData[activity]) changedData[activity] = {};
                if (!changedData[activity][change_date]) changedData[activity][change_date] = {};

                changedData[activity][change_date][field] = value;
                console.log(changedData)
                console.log(typeof changedData)
                }

            async function saveChanges() {
                console.log( "Changes ")


                data = await fetch("/submitTracker", {
                    method: "POST",
                    headers: {
                    "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                    start_date: startDate.toISOString().split("T")[0],
                    changes: changedData
                    })
                })
                // .then(res => res.json())
                // .then(data => {
                //     alert("Saved!");
                //     Object.keys(changedData).forEach(k => delete changedData[k]);
                // });
                }
            
            function renderWeek(days = 7) {
                // Clear old columns
                headerRow.innerHTML = "<th>Activity</th>";
                bodyRows.forEach(row => {
                    const activityName = row.children[0].textContent;
                    row.innerHTML = `<th>${activityName}</th>`;
                });

                const today = new Date().toDateString(); // Today
                let highlightIndex = null;

                for (let i = 0; i < days; i++) {
                    // Compute the date for this column
                    const date = new Date(startDate);
                    const checkdate = new Date(startDate);
                    date.setDate(startDate.getDate() + i); // startDate might be today - 3
                    checkdate.setDate(startDate.getDate() + i); // startDate might be today - 3

                    // Header Cell
                    const th = document.createElement("th");
        
                    if (checkdate.getTime() === todayDate.getTime()) {
                    th.classList.add("highlight-column");
                }
                    const date_for = date.toLocaleDateString("en-US", {
                        weekday: "short",
                        day: "2-digit",
                        month: "short"
                    });
                    if (checkdate.getTime()  === todayDate.getTime() ){
                        th.textContent = "Today " + date_for;


                    }else{
                    th.textContent = date_for;
                    }
                    // th.onclick = () => showMenu(th);
                    headerRow.appendChild(th);
                    
                    

                    // Body cells
                    bodyRows.forEach((row, idx) => {
                        const td = document.createElement("td");
                        if (checkdate.getTime()  === todayDate.getTime() ){
                            td.classList.add("highlight-column")

                        }

                        // Select dropdown
                        const select = document.createElement("select");
                        [
                            {v: "-", t:"‚úãüèª No Work"},
                            {v: "‚úî", t: "‚úÖ Done"},
                            {v: "‚úñ", t: "‚ùå Not Done"},
                            {v: "~", t: "ü§ô Continue"}
                        ].forEach(optData => {
                            const opt = document.createElement("option");
                            opt.value = optData.v;
                            opt.textContent = optData.t;
                            select.appendChild(opt);
                        });

                        // Textarea
                        const textarea = document.createElement("textarea");

                        // Inject database data
                        const dayData = totalweekdata[i];
                        if (dayData && dayData.habits) {
                            const habitName = activities[idx];
                            const habitData = dayData.habits[habitName];
                            if (habitData) {
                                select.value = habitData.status || "-";
                                textarea.value = habitData.note || "";
                            }
                        }

                        select.onchange = () => markChanged(activities[idx], i, "status", select.value, date);
                        textarea.oninput = () => markChanged(activities[idx], i, "note", textarea.value, date);

                        td.append(select, textarea);
                        td.addEventListener('click', function(e) {
                    // Stop selection if clicking inside the select or textarea specifically
                    // (Optional: remove this if you want the border even when typing)
                    handleCellSelection(td);
                    
                    // Call your existing showMenu function
                    showMenu(td, e);
                });
                        td.onclick = (e) => showMenu(td, e);
                        row.appendChild(td);
                    });
                    
                    // th.classList.add("highlight-column");


                }

                
                
            }

            
            function handleCellSelection(clickedTd) {
            // 1. Remove 'selected-cell' class from any previously selected cell
            const previouslySelected = document.querySelector('.selected-cell');
            if (previouslySelected) {
                previouslySelected.classList.remove('selected-cell');
            }

            // 2. Add the class to the clicked cell
            clickedTd.classList.add('selected-cell');
        }

            function showMenu(cell, event){
                if (event) event.stopPropagation();
                document.querySelectorAll(".cell-menu").forEach(m => m.style.display = "none");
                const menu = cell.querySelector(".cell-menu");
                if (menu) menu.style.display = "block";
            }

            document.body.onclick = () => {
                document.querySelectorAll(".cell-menu").forEach(m => m.style.display = "none");                
            };

            function updateCell(e) {
                e.stopPropagation();
                alert("Update cell");
            }

            function deleteCell(e){
                e.stopPropagation();
                const td = e.target.closet("td");
                td.querySelector("select").value = "-";
                td.querySelector("textarea").value = "";
                alert("Delete Cell")
            }

            function changeWeek(offset) {
                

                startDate.setDate(startDate.getDate() + offset *7);
                renderWeek();
            }

            async function addDay() {
                day = day +1; 
                endDate.setDate(endDate.getDate() + 1);
                const response = await fetch(`/retrieve_data?start=${startDate.toISOString()}&end=${endDate.toISOString()}&day=${day}`);
                const updateddata = await response.json();
                console.log(updateddata)

                totalweekdata = updateddata
                renderWeek(headerRow.children.length  );
            }

            async function addWeek() {
                day =  7;
                startDate.setDate(startDate.getDate() + 7);
                endDate.setDate(endDate.getDate() + 7);

                const response = await fetch(`/week_data?start=${startDate.toISOString()}&end=${endDate.toISOString()}&day=${day}&movement=${1}`);
                const updatedweekdata = await response.json();
                console.log(startDate, endDate)
                // console.log(updatedweekdata)

                totalweekdata = updatedweekdata
                console.log(totalweekdata)
                console.log(updatedweekdata)
                renderWeek(day , 1)

            }

            async function previousWeek() {
                day = 7;
                startDate.setDate(startDate.getDate() - 7);
                endDate.setDate(endDate.getDate() - 7);

                const response = await fetch(`/week_data?start=${startDate.toISOString()}&end=${endDate.toISOString()}&day=${day}&movement=${-1}`);

                const updatedweekdata = await response.json();
                // console.log(updateddata)
                console.log(startDate, endDate)

                totalweekdata = updatedweekdata
                console.log(totalweekdata)
                console.log(updatedweekdata)
                console.log(headerRow.children.length)
                renderWeek(day, -1)

            }

            // Initial render
            renderWeek();


            
        
        </script>

    </body>
</html>