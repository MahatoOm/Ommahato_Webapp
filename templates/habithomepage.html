<!DOCTYPE html>
<html lang = "en">
    <head>
        <meta charset="UTF-8">
        <title>
            Habit Tracker
        </title>
        <style>
            table {
                border-collapse: collapse;
                width: 100;
            }
            th, td {
                border: 1px solid #444;
                position:relative;
            }
            th {
                background : #f2f2f2;
            }

            select, textarea {
                width:90%;
                margin-top:4px;
            }
            textarea {
                height : 45px;
            }
            

            /* Floating action menu */
            .cell-menu {
            display: none;
            position: absolute;
            top: 4px;
            right: 4px;
            background: #fff;
            border: 1px solid #aaa;
            z-index: 10;
            }
            .cell-menu button {
            display: block;
            width: 100%;
            border: none;
            background: none;
            padding: 4px 8px;
            cursor: pointer;
            }
            .cell-menu button:hover {
            background: #eee;
            }

            .nav-controls{
                display : flex;
                justify-content:space-between;
                margin-bottom: 10px;
            }

            .head-controls{
                display : flex;
                justify-content:space-between;
                margin-bottom: 10px;
                margin-left: 20px;
                margin-right:20px;
            }
            .login{
                margin:100px;
            }
            head-admin{
                display: grid;
            }
            /* The class we will add to column i == 3 */
            .highlight-column {
                background-color: #f0f7ff !important; /* Light blue tint */
                border-left: 2px solid #3b82f6 !important;
                border-right: 2px solid #3b82f6 !important;
                position: relative;
                z-index: 10;
                /* This creates the blue shadow "lift" effect */
                box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2), 
                            0 4px 6px -2px rgba(59, 130, 246, 0.1);
            }

            /* Add top border to header cell only */
            th.highlight-column {
                border-top: 2px solid #3b82f6 !important;
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
                color: #f59e0b
            }

            /* Add bottom border to last row cell only */
            tr:last-child td.highlight-column {
                border-bottom: 2px solid #3b82f6 !important;
                border-bottom-left-radius: 8px;
                border-bottom-right-radius: 8px;
            }
            /* Style for the currently selected cell */
            .selected-cell {
                background-color: #fffbeb !important; /* Light amber/yellow background */
                outline: 3px solid #f59e0b !important; /* Amber border */
                outline-offset: -3px; /* Keeps the outline inside the cell */
                z-index: 20;
                position: relative;
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>

    </head>
    <body>
        <div class = "head-controls">  
        <div>
            <h1>
            Habit Tracker
        </h1>
        </div>
        <div id = head-admin>
            <form action = '/login'>
            
            <h3>Hi, {{ username }} </h3>
            <h5>{{ email }}</h5>
            {% if username == "Friend"  or username == None %}
            <button id='actionlogin' name='actionlogin'>Login/Sign Up</button>
            <p>Status: <span id="statusMessage">Waiting...</span></p>
            {% endif %}    
            </form>
        
        
        </div>      
        
        </div>

        <div class="nav-controls">
            <div>
                <button onclick="changeWeek(-1)"> üëà Previouos Week</button>
                <button onclick="changeWeek(1)"> üëâ Next Week</button>
            </div>

            <div>
                
                <button onclick="addDay()">üóΩ New Day</button>
                <button onclick="previousWeek()">üóΩ Previous Week</button>
                <button onclick="addWeek()">üóìÔ∏è New Week</button>
            </div>
        </div>

        <form>
            <table id = "trackerTable">
                <thead id = "headerRow">
                    <tr id = "dateRow">
                        <th>Activity</th>
                    </tr>
                </thead>
                <tbody id = "bodyRows">
                    {% for activity in activities %}
                    <tr>
                        
                        <th>{{ activity }}</th>
                        
                    </tr>
                    {% endfor %}
                    
                </tbody>
            </table>

            <br>
            <button onclick = saveChanges() > Save All</button>
        </form>

        <script>
            // converting python list to javascript readable format, Json is that bridge

            activities = JSON.parse('{{ activities | tojson | safe }}');
            totalweekdata = {{ totalweekdata | tojson }};
            console.log("Activities:", activities);

            const table = document.getElementById("trackerTable");
            const headerRow = document.getElementById("dateRow");
            const bodyRows = table.querySelectorAll("tbody tr");
            // const bodyRows = Array.from(document.getElementById("bodyRows").children);


            // tracks current time Sun Dec 14 2025 6:38:32 GMT-0600 
            let startDate = new Date();
            startDate.setDate(startDate.getDate() - 3);
            let endDate = new Date();
            endDate.setDate(startDate.getDate() +7);
            let day = 7;


            const changedData = {};
            function markChanged(activity, dayIndex, field, value, chdate) {
                change_date = chdate.getFullYear() + "-" +
                        String(chdate.getMonth() + 1).padStart(2, "0") + "-" +
                        String(chdate.getDate()).padStart(2, "0");
                if (!changedData[activity]) changedData[activity] = {};
                if (!changedData[activity][change_date]) changedData[activity][change_date] = {};

                changedData[activity][change_date][field] = value;
                console.log(changedData)
                console.log(typeof changedData)
                }

            async function saveChanges() {
                console.log( "Changes ")


                data = await fetch("/submitTracker", {
                    method: "POST",
                    headers: {
                    "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                    start_date: startDate.toISOString().split("T")[0],
                    changes: changedData
                    })
                })
                // .then(res => res.json())
                // .then(data => {
                //     alert("Saved!");
                //     Object.keys(changedData).forEach(k => delete changedData[k]);
                // });
                }
            
            function renderWeek(days = 7) {
    // Clear old columns
    headerRow.innerHTML = "<th>Activity</th>";
    bodyRows.forEach(row => {
        const activityName = row.children[0].textContent;
        row.innerHTML = `<th>${activityName}</th>`;
    });

    const today = new Date().toDateString(); // Today
    let highlightIndex = null;

    for (let i = 0; i < days; i++) {
        // Compute the date for this column
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i); // startDate might be today - 3

        // Header Cell
        const th = document.createElement("th");
        if (i == 3) {
        th.classList.add("highlight-column");
    }
        const date_for = date.toLocaleDateString("en-US", {
            weekday: "short",
            day: "2-digit",
            month: "short"
        });
        if (i == 3){
            th.textContent = "Today " + date_for;


        }else{
        th.textContent = date_for;
        }
        // th.onclick = () => showMenu(th);
        headerRow.appendChild(th);
        
        

        // Body cells
        bodyRows.forEach((row, idx) => {
            const td = document.createElement("td");
            if (i == 3){
                td.classList.add("highlight-column")

            }

            // Select dropdown
            const select = document.createElement("select");
            [
                {v: "-", t:"‚úãüèª No Work"},
                {v: "‚úî", t: "‚úÖ Done"},
                {v: "‚úñ", t: "‚ùå Not Done"},
                {v: "~", t: "ü§ô Continue"}
            ].forEach(optData => {
                const opt = document.createElement("option");
                opt.value = optData.v;
                opt.textContent = optData.t;
                select.appendChild(opt);
            });

            // Textarea
            const textarea = document.createElement("textarea");

            // Inject database data
            const dayData = totalweekdata[i];
            if (dayData && dayData.habits) {
                const habitName = activities[idx];
                const habitData = dayData.habits[habitName];
                if (habitData) {
                    select.value = habitData.status || "-";
                    textarea.value = habitData.note || "";
                }
            }

            select.onchange = () => markChanged(activities[idx], i, "status", select.value, date);
            textarea.oninput = () => markChanged(activities[idx], i, "note", textarea.value, date);

            td.append(select, textarea);
            td.addEventListener('click', function(e) {
        // Stop selection if clicking inside the select or textarea specifically
        // (Optional: remove this if you want the border even when typing)
        handleCellSelection(td);
        
        // Call your existing showMenu function
        showMenu(td, e);
    });
            td.onclick = (e) => showMenu(td, e);
            row.appendChild(td);
        });
        
        // th.classList.add("highlight-column");


    }

    
    
}

            
            function handleCellSelection(clickedTd) {
            // 1. Remove 'selected-cell' class from any previously selected cell
            const previouslySelected = document.querySelector('.selected-cell');
            if (previouslySelected) {
                previouslySelected.classList.remove('selected-cell');
            }

            // 2. Add the class to the clicked cell
            clickedTd.classList.add('selected-cell');
        }

            function showMenu(cell, event){
                if (event) event.stopPropagation();
                document.querySelectorAll(".cell-menu").forEach(m => m.style.display = "none");
                const menu = cell.querySelector(".cell-menu");
                if (menu) menu.style.display = "block";
            }

            document.body.onclick = () => {
                document.querySelectorAll(".cell-menu").forEach(m => m.style.display = "none");                
            };

            function updateCell(e) {
                e.stopPropagation();
                alert("Update cell");
            }

            function deleteCell(e){
                e.stopPropagation();
                const td = e.target.closet("td");
                td.querySelector("select").value = "-";
                td.querySelector("textarea").value = "";
                alert("Delete Cell")
            }

            function changeWeek(offset) {
                startDate.setDate(startDate.getDate() + offset *7);
                renderWeek();
            }

            async function addDay() {
                day = day +1; 
                endDate.setDate(endDate.getDate() + 1);
                const response = await fetch(`/retrieve_data?start=${startDate.toISOString()}&end=${endDate.toISOString()}&day=${day}`);
                const updateddata = await response.json();
                console.log(updateddata)

                totalweekdata = updateddata
                renderWeek(headerRow.children.length  );
            }

            async function addWeek() {
                day =  7;
                startDate.setDate(startDate.getDate() + 7);
                endDate.setDate(endDate.getDate() + 7);

                const response = await fetch(`/week_data?start=${startDate.toISOString()}&end=${endDate.toISOString()}&day=${day}&movement=${1}`);
                const updatedweekdata = await response.json();
                console.log(startDate, endDate)
                // console.log(updatedweekdata)

                totalweekdata = updatedweekdata
                console.log(totalweekdata)
                console.log(updatedweekdata)
                renderWeek(day , 1)

            }

            async function previousWeek() {
                day = 7;
                startDate.setDate(startDate.getDate() - 7);
                endDate.setDate(endDate.getDate() - 7);

                const response = await fetch(`/week_data?start=${startDate.toISOString()}&end=${endDate.toISOString()}&day=${day}&movement=${-1}`);

                const updatedweekdata = await response.json();
                // console.log(updateddata)
                console.log(startDate, endDate)

                totalweekdata = updatedweekdata
                console.log(totalweekdata)
                console.log(updatedweekdata)
                console.log(headerRow.children.length)
                renderWeek(day, -1)

            }

            // Initial render
            renderWeek();


            
        
        </script>

    </body>
</html>